<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калькулятор пирса</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <style>
        body { padding: 20px; padding-bottom: 40px; }
        .svg-container { border: 1px solid #ccc; margin-bottom: 20px; max-width: 400px; }
        .svg-container svg { max-width: 100%; height: auto; }
        .table th { background-color: #f8f9fa; }
        .accordion-button { font-weight: bold; }
        .error-message { display: none; color: red; }
        text { font-size: 12px; dominant-baseline: middle; text-anchor: middle; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">Калькулятор пирса</h1>
        <form method="post" class="row g-3">
            {% csrf_token %}
            <div class="col-md-6">
                <label class="form-label">Длина пирса (м):</label>
                <input type="text" name="length" class="form-control" value="{{ result.original_length|default_if_none:'' }}">
            </div>
            <div class="col-md-6">
                <label class="form-label">Ширина пирса (м):</label>
                <input type="text" name="width" class="form-control" value="{{ result.original_width|default_if_none:'' }}">
            </div>
            <div class="col-md-4">
                <label class="form-label">Расстояние между стойками по длине (м, опц.):</label>
                <input type="text" name="spacing_length" class="form-control" value="{{ result.input_spacing_length }}">
            </div>
            <div class="col-md-4">
                <label class="form-label">Расстояние между стойками по ширине (м, опц.):</label>
                <input type="text" name="spacing_width" class="form-control" value="{{ result.input_spacing_width }}">
            </div>
            <div class="col-md-4">
                <label class="form-label">Расстояние между лагами (м, опц.):</label>
                <input type="text" name="lag_spacing" class="form-control" value="{{ result.input_lag_spacing }}">
            </div>
            <div class="col-md-4">
                <label class="form-label">Выбор направляющего бруса:</label>
                <select name="beam_size" class="form-select">
                    <option value="6x6" {% if result.beam_size == '6x6' %}selected{% endif %}>6×6 дюймов</option>
                    <option value="8x8" {% if result.beam_size == '8x8' %}selected{% endif %}>8×8 дюймов</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Направление фронта:</label>
                <select name="front_direction" class="form-select">
                    <option value="length" {% if result.front_direction == 'length' %}selected{% endif %}>Фронт вдоль длины</option>
                    <option value="width" {% if result.front_direction == 'width' %}selected{% endif %}>Фронт вдоль ширины</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Направление настила:</label>
                <select name="deck_direction" class="form-select">
                    <option value="length" {% if result.deck_direction == 'length' %}selected{% endif %}>3×8 вдоль длины</option>
                    <option value="width" {% if result.deck_direction == 'width' %}selected{% endif %}>3×8 вдоль ширины</option>
                </select>
            </div>
            <div class="col-12 mt-3 d-grid gap-2 d-md-flex justify-content-md-start">
                <button type="submit" name="action" value="calculate" class="btn btn-primary">
                    <i class="fas fa-calculator"></i> Рассчитать
                </button>
                <button type="submit" name="action" value="reset" class="btn btn-secondary">
                    <i class="fas fa-trash"></i> Очистить
                </button>
            </div>
        </form>

        {% if result %}
        <div class="row mt-4">
            <div class="col-md-6">
                <h3><i class="fas fa-drafting-compass"></i> Схема пирса</h3>
                <div class="svg-container">
                    <svg id="pierSchema" width="400" height="300"></svg>
                </div>
                <div id="schemaError" class="error-message">Ошибка при отображении схемы. Проверьте введённые данные.</div>
  <script>
(function(){
  // Ждём JSON из views.py: result.schema_data — СТРОКА JSON
  var raw = '{{ result.schema_data|safe }}';
  try {
    var data = raw ? JSON.parse(raw) : null;
    if (!data || !data.dimensions) return;

    // 1) Геометрия: X = ширина, Y = длина (как на твоём образце)
    var L = +data.dimensions.length || 0;  // метры
    var W = +data.dimensions.width  || 0;  // метры
    if (L <= 0 || W <= 0) return;

    var scale = 40; // px/м — при желании поменяешь
    var pad   = {l:60,t:60,r:140,b:100}; // поля под подписи

    var width  = W * scale;   // по X — ШИРИНА
    var height = L * scale;   // по Y — ДЛИНА

    var X0 = pad.l, Y0 = pad.t, XR = X0 + width, YB = Y0 + height;
    var CX = (X0 + XR)/2, CY = (Y0 + YB)/2;

    // 2) Готовим SVG
    var svg = document.getElementById('pierSchema');
    if (!svg) return;
    var NS = 'http://www.w3.org/2000/svg';
    var vbW = pad.l + width + pad.r, vbH = pad.t + height + pad.b;
    svg.setAttribute('viewBox', '0 0 ' + vbW + ' ' + vbH);
    svg.innerHTML = ''; // чистим

    function E(n,a){ var el=document.createElementNS(NS,n); for(var k in a){el.setAttribute(k,a[k])} return el; }

    // 3) Тело пирса
    svg.appendChild(E('rect',{x:X0,y:Y0,width:width,height:height,fill:'#e6f7fb',stroke:'#000','stroke-width':2,rx:4}));

    // 4) Ряды 3×8 + коричневая стрелка
    var n = Math.max(0, +data.num_lines_3x8 || 0);
    if (n > 0) {
      if (data.deck_direction === 'length') {
        // «вдоль длины» — горизонтальные линии
        for (var i=1;i<=n;i++){
          var y = Y0 + i*(height/(n+1));
          svg.appendChild(E('line',{x1:X0,y1:y,x2:XR,y2:y,stroke:'#8B4513','stroke-width':3,opacity:0.9}));
        }
        // Стрелка и подпись после линий
        var ya = CY, xa1 = X0+20, xa2 = XR-20;
        svg.appendChild(E('line',{x1:xa1,y1:ya,x2:xa2,y2:ya,stroke:'#8B4513','stroke-width':3}));
        svg.appendChild(E('polygon',{points:(xa2-8)+','+(ya-5)+' '+xa2+','+ya+' '+(xa2-8)+','+(ya+5), fill:'#8B4513'}));
        var t = E('text',{x:CX,y:ya+15,fill:'#8B4513','text-anchor':'middle'});
        t.textContent='Брусья 3×8';
        svg.appendChild(t);
      } else {
        // «вдоль ширины» — вертикальные линии
        for (var j=1;j<=n;j++){
          var x = X0 + j*(width/(n+1));
          svg.appendChild(E('line',{x1:x,y1:Y0,x2:x,y2:YB,stroke:'#8B4513','stroke-width':3,opacity:0.9}));
        }
        // Стрелка и подпись после линий
        var xa = CX, ya1 = Y0+20, ya2 = YB-20;
        svg.appendChild(E('line',{x1:xa,y1:ya1,x2:xa,y2:ya2,stroke:'#8B4513','stroke-width':3}));
        svg.appendChild(E('polygon',{points:(xa-5)+','+(ya2-8)+' '+xa+','+ya2+' '+(xa+5)+','+(ya2-8), fill:'#8B4513'}));
        var t2 = E('text',{x:xa+25,y:CY,fill:'#8B4513'});
        t2.setAttribute('transform','rotate(90, '+(xa+25)+', '+CY+')');
        t2.textContent='Брусья 3×8';
        svg.appendChild(t2);
      }
    }

    // 5) Фронт как ОСЬ: рисуем только одну линию со стороны фронта, оранжевым
    if (data.front_direction === 'width') {
      // Фронт вдоль ширины — нижняя линия
      svg.appendChild(E('line',{x1:X0,y1:YB,x2:XR,y2:YB,stroke:'#fd7e14','stroke-width':4}));
      var f = E('text',{x:CX,y:YB+18,fill:'#fd7e14','text-anchor':'middle'}); 
      f.textContent='Фронт (ось: ширина)'; 
      svg.appendChild(f);
    } else {
      // Фронт вдоль длины — левая линия
      svg.appendChild(E('line',{x1:X0,y1:Y0,x2:X0,y2:YB,stroke:'#fd7e14','stroke-width':4}));
      var f2 = E('text',{x:X0-18,y:CY,fill:'#fd7e14'}); f2.setAttribute('transform','rotate(-90, '+(X0-18)+', '+CY+')'); f2.textContent='Фронт (ось: длина)'; svg.appendChild(f2);
    }

    // 6) Стойки (если переданы)
    if (Array.isArray(data.posts)) {
      data.posts.forEach(function(p){
        var px = X0 + (p.y||0) * scale + scale/2; // X = ширина (м), по центру ячейки
        var py = Y0 + (p.x||0) * scale + scale/2; // Y = длина  (м), по центру ячейки
        svg.appendChild(E('circle',{cx:px,cy:py,r:4,fill:'#dc3545',stroke:'#fff','stroke-width':1}));
      });
    }

    // 7) Размерные линии — Ширина сверху, Длина справа (чтобы не налезали)
    // — ширина
    var wy = Y0 - 28;
    svg.appendChild(E('line',{x1:X0,y1:wy,x2:XR,y2:wy,stroke:'#475569','stroke-width':2}));
    svg.appendChild(E('polygon',{points:(XR-8)+','+(wy-5)+' '+XR+','+wy+' '+(XR-8)+','+(wy+5), fill:'#475569'}));
    svg.appendChild(E('polygon',{points:(X0+8)+','+(wy-5)+' '+X0+','+wy+' '+(X0+8)+','+(wy+5), fill:'#475569'}));
    var wt = E('text',{x:CX,y:wy-8,fill:'#475569','text-anchor':'middle'}); wt.textContent='Ширина: '+W.toFixed(2)+' м'; svg.appendChild(wt);
    // — длина
    var lx = XR + 28;
    svg.appendChild(E('line',{x1:lx,y1:Y0,x2:lx,y2:YB,stroke:'#475569','stroke-width':2}));
    svg.appendChild(E('polygon',{points:(lx-5)+','+(YB-8)+' '+lx+','+YB+' '+(lx+5)+','+(YB-8), fill:'#475569'}));
    svg.appendChild(E('polygon',{points:(lx-5)+','+(Y0+8)+' '+lx+','+Y0+' '+(lx+5)+','+(Y0+8), fill:'#475569'}));
    var lt = E('text',{x:lx+12,y:CY,fill:'#475569'}); lt.setAttribute('transform','rotate(90, '+(lx+12)+', '+CY+')'); lt.textContent='Длина: '+L.toFixed(2)+' м'; svg.appendChild(lt);

  } catch(e) {
    console.error('schema error', e);
    var err = document.getElementById('schemaError'); if (err) err.style.display = 'block';
  }
})();
</script>
            </div>
            <div class="col-md-6">
                <div class="accordion" id="resultsAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#posts">
                                <i class="fas fa-columns"></i> Стойки
                            </button>
                        </h2>
                        <div id="posts" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-sm">
                                        <tr><th>Параметр</th><th>Значение</th></tr>
                                        <tr><td>Исходная длина</td><td>{{ result.original_length|floatformat:2 }} м</td></tr>
                                        <tr><td>Исходная ширина</td><td>{{ result.original_width|floatformat:2 }} м</td></tr>
                                        <tr><td>Длина с учётом фронта</td><td>{{ result.adjusted_length|floatformat:2 }} м</td></tr>
                                        <tr><td>Ширина с учётом фронта</td><td>{{ result.adjusted_width|floatformat:2 }} м</td></tr>
                                        <tr><td>Расстояние по длине</td><td>{{ result.spacing_length|floatformat:2 }} м</td></tr>
                                        <tr><td>Количество по длине</td><td>{{ result.count_length }}</td></tr>
                                        <tr><td>Расстояние по ширине</td><td>{{ result.spacing_width|floatformat:2 }} м</td></tr>
                                        <tr><td>Количество по ширине</td><td>{{ result.count_width }}</td></tr>
                                        <tr><td>Всего стоек</td><td>{{ result.total_posts }}</td></tr>
                                        <tr><td>Площадь пирса</td><td>{{ result.total_area|floatformat:2 }} м²</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#beams">
                                <i class="fas fa-wood"></i> Брусья 3×8
                            </button>
                        </h2>
                        <div id="beams" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-sm">
                                        <tr><th>Параметр</th><th>Значение</th></tr>
                                        <tr><td>Длина одной линии</td><td>{{ result.line_length_3x8|floatformat:2 }} м</td></tr>
                                        <tr><td>Количество линий</td><td>{{ result.num_lines_3x8 }}</td></tr>
                                        <tr><td>Дополнительные вставки</td><td>{{ result.inserts_3x8|floatformat:2 }} м</td></tr>
                                        <tr><td>Общий метраж</td><td>{{ result.total_3x8_meters|floatformat:2 }} м</td></tr>
                                        <tr><td>Количество досок (6 м)</td><td>{{ result.total_3x8_boards }}</td></tr>
                                        <tr><td>Болты</td><td>{{ result.bolts_beam_count }}</td></tr>
                                        <tr><td>Метраж болтов</td><td>{{ result.bolts_beam_meterage|floatformat:2 }} м</td></tr>
                                        <tr><td>Гайки</td><td>{{ result.nuts_beam_count }}</td></tr>
                                        <tr><td>Шайбы</td><td>{{ result.washers_beam_count }}</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#lags">
                                <i class="fas fa-wood"></i> Лаги 3×6
                            </button>
                        </h2>
                        <div id="lags" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-sm">
                                        <tr><th>Параметр</th><th>Значение</th></tr>
                                        <tr><td>Количество рядов</td><td>{{ result.num_lag_rows }}</td></tr>
                                        <tr><td>Длина одной лаги</td><td>{{ result.lag_row_length|floatformat:2 }} м</td></tr>
                                        <tr><td>Общая длина</td><td>{{ result.total_lag_meterage|floatformat:2 }} м</td></tr>
                                        <tr><td>Количество досок (6 м)</td><td>{{ result.lag_boards_needed }}</td></tr>
                                        <tr><td>Шурупы 30 мм</td><td>{{ result.lag_screws }}</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#deck">
                                <i class="fas fa-wood"></i> Настил 3×6
                            </button>
                        </h2>
                        <div id="deck" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-sm">
                                        <tr><th>Параметр</th><th>Значение</th></tr>
                                        <tr><td>Количество рядов</td><td>{{ result.board_rows }}</td></tr>
                                        <tr><td>Количество досок в ряду</td><td>{{ result.boards_per_row }}</td></tr>
                                        <tr><td>Общая длина</td><td>{{ result.total_deck_meterage|floatformat:2 }} м</td></tr>
                                        <tr><td>Количество досок (6 м)</td><td>{{ result.deck_boards_needed }}</td></tr>
                                        <tr><td>Шурупы 30 мм</td><td>{{ result.deck_screws }}</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#diagonals">
                                <i class="fas fa-wood"></i> Диагональные укосы 3×6
                            </button>
                        </h2>
                        <div id="diagonals" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-sm">
                                        <tr><th>Параметр</th><th>Значение</th></tr>
                                        <tr><td>Диагонали вдоль длины</td><td>{{ result.cross_count_length }}</td></tr>
                                        <tr><td>Диагонали вдоль ширины</td><td>{{ result.cross_count_width }}</td></tr>
                                        <tr><td>Всего диагоналей</td><td>{{ result.cross_count_total }}</td></tr>
                                        <tr><td>Общий метраж</td><td>{{ result.total_cross_meters|floatformat:2 }} м</td></tr>
                                        <tr><td>Количество досок (6 м)</td><td>{{ result.cross_boards_needed }}</td></tr>
                                        <tr><td>Болты</td><td>{{ result.total_bolts_cross }}</td></tr>
                                        <tr><td>Гайки</td><td>{{ result.nuts_cross_count }}</td></tr>
                                        <tr><td>Шайбы</td><td>{{ result.washers_cross_count }}</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#front">
                                <i class="fas fa-wood"></i> Фронт
                            </button>
                        </h2>
                        <div id="front" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-sm">
                                        <tr><th>Параметр</th><th>Значение</th></tr>
                                        <tr><td>Количество досок 3×6</td><td>{{ result.front_boards_count }}</td></tr>
                                        <tr><td>Общая длина 3×6</td><td>{{ result.front_boards_meters|floatformat:2 }} м</td></tr>
                                        <tr><td>Количество кубиков</td><td>{{ result.front_cubes_count }}</td></tr>
                                        <tr><td>Шурупы 40 мм (доски)</td><td>{{ result.front_board_screws }}</td></tr>
                                        <tr><td>Шурупы 30 мм (кубики)</td><td>{{ result.cube_screws }}</td></tr>
                                        <tr><td>Направляющий брус {{ result.beam_size }}</td><td>{{ result.front_beam_meterage|floatformat:2 }} м</td></tr>
                                        <tr><td>Количество досок (6 м)</td><td>{{ result.front_beam_boards }}</td></tr>
                                        <tr><td>Соединения (1.2 м)</td><td>{{ result.front_connections }}</td></tr>
                                        <tr><td>Болты</td><td>{{ result.front_beam_bolts }}</td></tr>
                                        <tr><td>Гайки</td><td>{{ result.front_beam_nuts }}</td></tr>
                                        <tr><td>Шайбы</td><td>{{ result.front_beam_washers }}</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#summary" aria-expanded="true">
                                <i class="fas fa-list"></i> Сводка материалов
                            </button>
                        </h2>
                        <div id="summary" class="accordion-collapse collapse show">
                            <div class="accordion-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-sm">
                                        <thead><tr><th>Материал</th><th>Метраж (м)</th><th>Количество (шт)</th></tr></thead>
                                        <tbody>
                                            <tr><td>Стойки</td><td>-</td><td>{{ result.total_posts_count }}</td></tr>
                                            <tr><td>Брусья 3×8</td><td>{{ result.total_3x8_meterage|floatformat:2 }}</td><td>{{ result.total_3x8_board_count }}</td></tr>
                                            <tr><td>Материал 3×6</td><td>{{ result.total_3x6_meterage|floatformat:2 }}</td><td>{{ result.total_3x6_board_count }}</td></tr>
                                            <tr><td>{{ result.beam_size }} направляющий</td><td>{{ result.total_guiding_meterage|floatformat:2 }}</td><td>{{ result.total_guiding_board_count }}</td></tr>
                                            <tr><td>Шурупы 30 мм</td><td>-</td><td>{{ result.total_screws_30 }}</td></tr>
                                            <tr><td>Шурупы 40 мм</td><td>-</td><td>{{ result.total_screws_40 }}</td></tr>
                                            <tr><td>Болты</td><td>{{ result.total_bolt_meterage_effective|floatformat:2 }}</td><td>{{ result.total_bolt_count }}</td></tr>
                                            <tr><td>Гайки</td><td>-</td><td>{{ result.total_nuts_count }}</td></tr>
                                            <tr><td>Шайбы</td><td>-</td><td>{{ result.total_washers_count }}</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                <a href="{% url 'pricing' %}" class="btn btn-success"><i class="fas fa-dollar-sign"></i> Перейти к расчёту стоимости</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        {% if error %}
        <div class="alert alert-danger mt-3">{{ error }}</div>
        {% endif %}
    </div>
</body>
</html>